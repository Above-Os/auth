// Copyright 2023 bytetrade
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package session

import (
	"encoding/json"
	"testing"

	"github.com/fasthttp/session/v2"
	"k8s.io/klog/v2"
)

func TestDecode(t *testing.T) {
	s := NewEncryptingSerializer("unsecure_session_secret")

	var sess session.Dict
	err := s.Decode(&sess, []byte("\x7f\xa8\xbb\xaf\xb5$\xe6\xf6.\xd8\xb2\x9a(\xb6+\x14;}o\x02\xca&a\xef\xef\x8f\xda\x8e\xc7d\x94\x81\x90d(\xec\xefZU\xdd6i\x01=\xf2om6\x80\xe6\"\x9b\x9b\xa0(\xa7\xa7\a\xf4b\xd4\xe3\"0>6i\x06\xd3n\xd4/\xcf\xc7\x87\x05\xe2\xf87\xbe\x14\x8a\x1a~L\xf7\xa9\xa4v\xf9\x0fWd\x16p\xe5\x89\x1d\x80\x9a#\xdc\xbd8\x03\xc6\xe3)1\xdcv\xedU]\xf9cq\xba\xf9\x14%(\xa0\x9ew\xa4\xbf\xfd7\x0el\x16 \xfaf\x98\xc5A\xb8_\\\x00'\xaf\x1e\xc1\a\xf25\xa4+\xc7\x8c\xf28\x87\xc7\xceEa\xb3^\xda\xe8\xc5\xa6\xd7[\xbb-\xb7lB\x1bo\xd6\x89\xb8\xec\x90\\\x8cz\xfdXA\xdf\xba</\xb7\xc6\xa4MA\xa4\x84\xf8a\xb8\x83X\xbb\x12\b\xb8N\x05\x10N\xf2\x05mn\xe6\xa5\xd2\xfc$\x84\xab\x95\xfc\xcb\xfc\xf5\\^\xd2\r\xfb\xc3\xbb8 <\xf2\xd7\xe3\xe3\x83o\xddJ\xb6j\"Cn\xe5\xb3\xa5!\xea\xbe\x86\x148\x11\xa3\xb34\xda\x0fcP\xc8\x93~}w\x86G\xfeI\x0b}\xa7i\xe4\xe8a\x93\xa9)\x03\xa3\xd8\x0fdnw\xde\x16\x12$\xa2\xa1\xcc\x8cN2\x81;\xc62\x9f(34\x1c1\xf8\xb2\xf0Y/g\xdbQ-Y0\xf0\xdb\xeb\xac\x9c\xf0\xea\xc9 \xe1\xa2\x83\x9b\x04[\xb5\xc1k;\xd3\x12k\xe0\xd16W3\xcf\xd1~\x0e\xecKm\xa7\a\"\xfaF\x1e\x172\xdcnX\xc5\x9f\xdc0\xd1\xf7y\x15\xe7\xf0ve<\xd5\xbfF6\x97=\x87T\xe2\xcd\xaa\xb6\xf2\x97\xb3\x81z0D\x9cW\xa0,p\xe8J\x968\xbb[v\xd3\xe7FS\x19\aP\x05s_gI\x9c/\xab\xd0,z\xc6\xd0\xa2\xf8\x9e\xf3\xca\xc8\x85S\xf5\x0e\x1c@\xf3M\xbfv\xees\x13\xa2\xf2\x97\xa2r\xca\xc0\xee\x18\x7fVl\xb9~=\x99S\x0b\n\x98\xc8\x92i\xd94W\x98wI\xfdCs%D\xeab\xb8\xfea\xe7\xcd\x94\xa8r\x12l\x8f\xaaX\xb7<}\xedN9\x85+\xf1\x11r-he\xe3-\xd6\xe8\x0e\xa0\xc0\x84\xba\x9ay\xbf}\x0f\x93\xe8\xc3J\xed`\x92D4u\x0c\xd3*\xbd\xb5&C\x9a\xe8\xd9\x89}\xf2\xad\xea\x84\x10\x7f\xeb\x96\xbd\xb0\x95.?\xc6|\xdcE9\xf3d\x87\x1e\xa3\xf6P\xe0\xbda\xf8\xa8\x9fO2+\xad%\xcf\xc3\xe4^\xd8\xd8w\xd1P\x15%5t\xfa\x10l\xb7\xef\xa4\xbbT\x80\xf5@8\xdc\xeeu8\xa4W\xf1t\xd0\xc4\x8d:\x01\x8b\xe8\xca\x00hLZI\xec\x1c\xa3uZ<0\x13B\x05\x90\xee\x11\xc0a\xd2\x06/l\x97<=\xb55]\xf7>\x91<\xec\xc9\xfd\x01|\xb0\x1a\xfc\x00J\x91\xa6\x13\xa9\x8a=\xc8\x8f\x82\xe4E\xe9\xd7\xcf\xd9~\xbf\xde\x03\xc1?\x1f\x03R\xfa\xfe0hl\xc0\xba\x0f\xaeI\x06\xc2L\xffs\xb4)V\xaa\x7f\xe2Iz\xeaki\xb4@H\xee\x15\x14\x95\xbf\x1d%\xfb\x879>\xa0U+\x9f8\xbe\xc3\x162Ho\x88,^>\x96\xdc\x97\x86\x86Vn^\xf7\xab\t\x11\xf0\xaf\x7fb$\xd6\x83\xde\xe5 \xd2\xe3\xf1\xf4\xd6\x12i\x03sCNqj\x7f0r/\x1e\r\x0f\x95VX\b\x16f0\x15\xfc;\x12\x84\xbe\xec=r\xad\xd9\xe8\xad\xe2\xc9\x89\xb5$\x94\xad~\x02z\x1d\xcd\xb44\x02\x80\xd6\x10\xb6\x06\x92\xdb\x02tUc\xa4A\xb7\xa8\xd7\xad\x1a5\x904\xd2'(\xff\xe6d\x84P\xb8Lm\x90\xb4\xa5\xfea\xa3\x05\tJl\x17\x8b\xad\xfaB\x9c\xe8\x0b}\x94:m\xbb:Lc\xef\xfe\x0f\xe5\x01\xe7b\xd2\x1b\xd6\xf3\x89\xd7;\x96\xd34\xd3\xd5\x17}Y\x9d\xe5U\xedE\t\xd0\xd9D\xf1\x0b\xe2\xf1k\xdd_A{\x1a\xe4\xc7\xe11W\xaa\x97U\xca;\xe1\x86\x0f\xa7-\xf7\x83\xdeZ\xd5\x85\xdcG\r\xba\x05\xe3\xe0\xdb\xb0\x86V\x18L\xdc\t\x9c\xb5\xa5HMT\xc3\x9cv\xc55\xbaX\x96\x9f\x95\x98\x9d\x1e\x04\xdaH\x15\x94'\xe6\x1cY\xd9\xa9\xf0t\x0c\x90\xd0\xed*%\x03\x12\xa9\xdb\x7f\x9b\xc7{5\x1a6\a\xd9d\x1dr\x98\x1d\x8b\x12(m9\xf2z\x84\xf5\xd8\x12w\x1f\x90\xb9~vA>\xc7\xd7\x89W\xe5\xb4\x10\x9b\x9b\xfe\xea\x06\xc5\xc4\xf2\x0cr;\xcfN!*h\xc5\xa4%!%\x8c\xcd\xeb\n\xf6N\xf6\xc6u\xc4{\xba\xe6\x80&\x8e]\xf1\xc3i\x85\xef\xf8{\xd4\xa9\x86\x8f{\x1e3\xe2h\xc9\xf23[f\x10\xf9\xa1\xbfv\xc2\x9d\xaci\xa7\xfdFr\xd6v\x04\xe2\t\xbe\xee\xa5\x85\xea\x94\xfe\xa4)P\xdd\xdcO~\xd6\xc2\x93\xa7\xa2R\x17\xac4\xc3>\xb8\x1f<6\"\xed<R\x1ft\xa2B!\x82\xe6\xdf\x829O\x06\xf8\xf5\x8f\x1f\x06\xac\xfab\x01\x9fkd\xe0\x86\xbeq\x8f\xcb\xadf\xd5\xd8\xb4\xa0\xae\xba\x87\\\x97xuT\xde\xee\xe1\x93\xa4\x17C\x8b\xcf}\x9dxS\xcf\x80\x87+\xce\xf9\a\xb8w\xd1\x1eZ\x0b\x1d\x8c\xb9\xdb\xdbo\x13\x87\xe9_9\xb9@\xb5\xe0\xfe~\xa3\x1f\xc8ga\x9aQ\x1c@Cv\x1do\x99\xbd\xc7\x9b=\xbd\xf4S\xd5\xcc\x92 \x96\xe2\b[R+\x87\x8aG\xc0A\x03w\x04\x8bt\no\xac:\xff}\x1c\xed\x8a\\\xcdWP\\2\x7f(\xfd|\xd2\x04?\\\xb2\xa0\xf3\xa7\x18%\xf2l*\xf2\xc9|\x82#\nV\xd7\x80\xfbN8\xcd%\x04\xe7\xd6\xc3\xf4\xe8\x17A\xfci\x92\xb3\x8e\x03\xfe\xd2\x92C\x9b\xf06U\bF\xcc&Q\xe9\xd5\x83\x1fq\xda\x0f\xa2\x0f(\xc8\x02\x06\xe5\x9e;\x90\x16\xaa\x8b\x11\x89\x05\xde?yM\xae/\x89\x10\xc9\x81\xc2\xee6\xf5\x03P\x8a\xd7?\x95\x88\x82\x0e-|\xc0iU\x12\xdb\xb42\x046\x02\xa6\x83\xebD\xb4\xa1\xb2\xb3\xae\xe4\xa9\xa7\t\xce\x8cc\xd8p\xdb\x15\xe9\x95h\x01\xfd\xcd\xb2\xb8\xea\xb4\xe4\xae \xfb\xb72\xa6\x1b\xb0\xe8&ULg\x8aY\xf4\x13'\xb0I\x8a\x05{\xc5>/\xda\xa8O\x1eJt\\\xd3\xc9#\xf6=\xf3\xa2aL5\xe4\x13\xe6\xa2\xbc$\x1f\n\xces3\x87S\x16?5>u\x15\xb9\xe2\xcb\x81b\xae8\xbc M\x8aC4\xb9\xfd\xf7(\xa9\x8cfU\xe9!\x95}\x8d]'\xca%\xaeJ\xc4\x8c\x80\xd32SA\xc2`\xa1\x9e@/\xe0]\x17\x05\xd1\x13\xefj\xac\xef\x8a r\x86c\x8a)\xe49\x98\x1f\xb4\x12\xbf>\xb1;"))

	if err != nil {
		klog.Error(err)
		t.Fail()
	}

	var us UserSession
	_ = json.Unmarshal(sess.KV["UserSession"].([]byte), &us)

	d, _ := json.Marshal(us)
	klog.Info(string(d))
}
